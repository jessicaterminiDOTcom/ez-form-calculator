jQuery(document).ready(function(a){function c(b){var c="";c+="<li class='button ezfc-form' data-id='"+b.form.id+"' data-action='form_get' data-selectgroup='forms'>",c+="	<i class='fa fa-fw fa-list-alt'></i> ",c+=b.form.id+" - ",c+="	<span>"+b.form.name+"</span>",c+="</li>",a(".ezfc-forms-list").append(c),a(".ezfc-form.button-primary").removeClass("button-primary"),a(".ezfc-form[data-id='"+b.form.id+"']").addClass("button-primary"),g(b)}function d(b){a(".ezfc-form-elements-actions, .ezfc-form-elements-container, .ezfc-form-options-wrapper").addClass("ezfc-hidden"),a(".ezfc-form[data-id='"+b+"']").remove()}function e(b){a(".ezfc-form-file[data-id='"+b+"']").remove()}function f(b){return a(".ezfc-form-preview").html(b),b.length<1?!1:(a("html, body").animate({scrollTop:a(".ezfc-form-preview").offset().top-50},1337),void 0)}function g(b){form_changed=!1;var c="";a.each(b.elements,function(a,b){c+=j(b)}),a(".ezfc-form-submissions").addClass("ezfc-hidden"),a(".ezfc-form-elements-actions, .ezfc-form-elements-container, .ezfc-form-options-wrapper").removeClass("ezfc-hidden"),a(".ezfc-form-elements").html(c),a(".ezfc-form-elements").sortable({placeholder:"ui-state-highlight",revert:!0}).disableSelection(),a("#ezfc-form-save, #ezfc-form-delete").data("id",b.form.id),a("#ezfc-shortcode").text("[ezfc id='"+b.form.id+"']"),a("#ezfc-form-name").val(b.form.name),l(),h(b.options)}function h(b){a.each(b,function(b,c){var d="#opt-"+c.o_id;switch(c.type){case"yesno":case"lang":a(d+" option").removeAttr("selected"),a(d+" option[value='"+c.value+"']").attr("selected","selected");break;default:a(d).val(c.value)}})}function i(b){form_changed=!1;var c="<ul>";a.each(b.submissions,function(d,e){var f=new Date(Date.parse(e.date));c+="<li class='ezfc-form-submission' data-id='"+e.id+"'>",c+="	<div class='ezfc-form-submission-name'>",c+="		<i class='fa fa-fw fa-envelope'></i> ID: "+e.id+" - "+f.toUTCString(),c+="		<button class='ezfc-form-submission-delete button' data-action='form_submission_delete' data-id='"+e.id+"'><i class='fa fa-times'></i></button>",c+="	</div>",c+="	<div class='ezfc-form-submission-data hidden'>",c+=e.content,c+="	<div class='ezfc-form-files'>",c+="		<p>Files</p>",b.files[e.ref_id]&&a.each(b.files[e.ref_id],function(a,b){var d=b.url.split("/").slice(-1);c+="	<ul>",c+="		<li class='ezfc-form-file' data-id='"+b.id+"'>",c+="			<a href='"+b.url+"'>"+d+"</a>",c+="			<button class='ezfc-form-file-delete button' data-action='form_file_delete' data-id='"+b.id+"'><i class='fa fa-times'></i></button>",c+="	</li>",c+="	</ul>"}),c+="	</div>",c+="</li>"}),c+="</ul>",a(".ezfc-form-submissions").removeClass("ezfc-hidden").html(c),a(".ezfc-form-elements-container, .ezfc-form-options-wrapper").addClass("ezfc-hidden"),a(".ezfc-form-submission-data h2").remove()}function j(b){var c=a.parseJSON(b.data),d="",e="",f="";f+="<input type='hidden' class='ezfc-form-element-e_id' value='"+b.e_id+"' name='elements["+b.id+"][e_id]' />",f+="<table>",a.each(c,function(g,h){if("e_id"!=g&&"preselect"!=g){var i="elements-"+g+"-"+b.id,j="elements["+b.id+"]",k="elements["+b.id+"]["+g+"]",l="";if(l+="<input type='text' value='"+h+"' name='"+k+"' data-element-name='"+g+"' id='"+i+"' />","label"==g&&(d=h),"html"==g&&(l="<textarea name='"+k+"' id='"+i+"'>"+o(h)+"</textarea>"),"required"==g&&(e=1==h?"*":"",l="<select class='ezfc-form-element-required-toggle' name='"+k+"' id='"+i+"' data-element-name='"+g+"'>",l+="	<option value='0'>"+ezfc_vars.yes_no.no+"</option>",l+="	<option value='1'"+(1==h?"selected":"")+">"+ezfc_vars.yes_no.yes+"</option>",l+="</select>"),"calculate_enabled"==g&&(l="<select class='ezfc-form-element-calculate_enabled' name='"+k+"' id='"+i+"' data-element-name='"+g+"'>",l+="	<option value='0'>"+ezfc_vars.yes_no.no+"</option>",l+="	<option value='1'"+(1==h?"selected":"")+">"+ezfc_vars.yes_no.yes+"</option>",l+="</select>"),"multiple"==g&&(l="<select class='ezfc-form-element-multiple' name='"+k+"' id='"+i+"' data-element-name='"+g+"'>",l+="	<option value='0'>"+ezfc_vars.yes_no.no+"</option>",l+="	<option value='1'"+(1==h?"selected":"")+">"+ezfc_vars.yes_no.yes+"</option>",l+="</select>"),"options"==g){l="<button class='button ezfc-form-element-option-add' data-target='.ezfc-form-element-option' data-element_id='"+b.id+"'>Add Option</button>",l+="</td></tr>",l+="<tr>",l+="	<th scope='row'>Value</th>",l+="	<td>Text</td>",l+="	<td><abbr title='Preselect values'>Sel</abbr></td>",l+="	<td><abbr title='Remove item'>Rem</abbr></td>",l+="</tr>";var m=0,n=c.preselect?c.preselect:"",p="",q="",r=[];switch(ezfc.elements[b.e_id].name){case"Checkbox":preselect_name="preselect-dummy",q="checkbox",r=a.map(n.split(","),function(a){return parseInt(a)});break;case"Dropdown":case"Radio Button":preselect_name=j+"[preselect]",q="radio"}a.each(h,function(d,e){l+="<tr class='ezfc-form-element-option' data-element_id='"+b.id+"' data-row='"+m+"'>",l+="	<td><input class='ezfc-form-element-option-value small' name='"+k+"["+m+"][value]' value='"+e.value+"' type='text' /></td>",l+="	<td><input class='ezfc-form-element-option-text' name='"+k+"["+m+"][text]' type='text' value='"+e.text+"' /></td>",p=r.length>0?-1!=a.inArray(m,r)?"checked='checked'":"":c.preselect==m?"checked='checked'":"",l+="	<td><input class='ezfc-form-element-option-"+q+"' name='"+j+"[preselect]' type='"+q+"' data-element_id='"+b.id+"' value='"+m+"' "+p+" /></td>",l+="	<td><button class='button ezfc-form-element-option-delete' data-target='.ezfc-form-element-option' data-element_id='"+b.id+"' data-target_row='"+m+"'><i class='fa fa-times'></i></button></td>",l+="</tr>",m++}),"checkbox"==q&&(l+="<input class='ezfc-form-option-preselect' type='hidden' name='"+j+"[preselect]' data-element_id='"+b.id+"' value='"+n+"' />"),"radio"==q&&(p=-1==n?"checked='checked'":"",l+="<tr>",l+="	<td colspan='2'>No preselected value</td>",l+="	<td><input class='ezfc-form-element-option-radio' name='"+j+"[preselect]' type='radio' data-element_id='"+b.id+"' value='-1' "+p+" /></td>",l+="	<td></td>",l+="</tr>")}"calculate"==g&&(l="<select class='ezfc-form-element-calculate-operator' name='"+k+"[operator]' id='"+i+"-operator' data-element-name='"+g+"'>",l+="	<option value='0'> </option>",l+="	<option value='add'>+</option>",l+="	<option value='subtract'>-</option>",l+="	<option value='multiply'>*</option>",l+="	<option value='divide'>/</option>",l+="</select>",l+="<select class='ezfc-form-element-calculate-target' name='"+k+"[target]' id='"+i+"-target' data-element-name='"+g+"' data-calculate_operator='"+h.operator+"' data-calculate_target='"+h.target+"'>",l+="</select>"),"image"==g&&(l+="<button class='button ezfc-image-upload'>Choose image</button>",l+="<br><img src='"+h+"' class='ezfc-image-preview' />"),f+="<tr>",f+="	<th scope='row'>",f+="		<label for='"+k+"'>"+g.capitalize()+"</label>",f+="	</th>",f+="	<td>",f+=l,f+="	</td>",f+="</tr>"}}),f+="</table>",f+="<div class='text-right'>",f+="	",f+="</div>";var g=d.length>0?" - <span class='element-label'>"+d+"</span>":"",h="";return h+="<li class='ezfc-form-element' data-id='"+b.id+"'>",h+="	<div class='ezfc-form-element-name'>",h+="		<span class='fa fa-fw "+ezfc.elements[b.e_id].icon+"'></span>",h+="		<span class='ezfc-form-element-required-char'>"+e+"</span> ",h+="		<span class='ezfc-form-element-type'>"+ezfc.elements[b.e_id].name+"</span> "+g,h+="		<button class='ezfc-form-element-delete button' data-action='form_element_delete' data-id='"+b.id+"'><i class='fa fa-times'></i></button>",h+="		</div>",h+="	<div class='ezfc-form-element-data ezfc-form-element-"+ezfc.elements[b.e_id].name.replace(" ","-").toLowerCase()+" hidden'>"+f+"</div>",h+="</li>"}function l(){a(".ezfc-form-element-calculate-target").each(function(b,c){var d="<option value='0'> </option>",e=a(".ezfc-form-element-data"),f=a(this).data("calculate_operator"),g=a(this).data("calculate_target");a(e).each(function(b,c){if(!a(this).is(".ezfc-form-element-email, .ezfc-form-element-date, .ezfc-form-element-image, .ezfc-form-element-line, .ezfc-form-element-date, .ezfc-form-element-html, .ezfc-form-element-recaptcha, .ezfc-form-element-file-upload")){var e=a(c).parents(".ezfc-form-element"),f=a(e).data("id"),g=a(e).find("input[data-element-name='name']").val(),h=a(e).find(".ezfc-form-element-type").text();d+="<option value='"+f+"'>"+g+" ("+h+")</option>"}}),a(c).html(d),a(c).parent().find(".ezfc-form-element-calculate-operator option[value='"+f+"']").prop("selected","selected"),a(c).find("option[value='"+g+"']").prop("selected","selected")})}function m(b){a(".spinner").fadeIn("fast");var h=a(b).data("action"),k=a(".ezfc-forms-list .button-primary").data("id"),m=a(b).data("id"),n="action="+h;if(("form_add"==h||"form_template_delete"==h)&&(m=a("#ezfc-form-template-id option:selected").val()),("form_duplicate"==h||"form_preview"==h||"form_get_submissions"==h)&&(m=a(".ezfc-forms-list .button-primary").data("id")),"form_element_add"==h){if(!k)return!1;var o=m;n+="&e_id="+o+"&f_id="+k}if("form_element_delete"==h||"form_delete"==h||"form_submission_delete"==h||"form_template_delete"==h||"form_file_delete"==h){if("form_template_delete"==h&&0==m)return a(".spinner").hide(),!1;if(!confirm(ezfc_vars.delete_element))return a(".spinner").hide(),!1}if("form_save"==h||"form_preview"==h){a(".ezfc-form-element-checkbox").each(function(){var b=[];a(this).find(".ezfc-form-element-option-checkbox").each(function(c,d){a(d).is(":checked")&&b.push(a(d).val())}),a(this).find(".ezfc-form-option-preselect").val(b.join(","))});var p=a("#form-elements, #form-options").serialize(),q=a("#ezfc-form-name").val();n+="&"+p+"&ezfc-form-name="+q}if("form_save_template"==h&&(m=k),"form_show_options"==h)return a(".spinner").hide(),a(".ezfc-options-dialog").dialog("open"),!1;if("form_update_options"==h){var p=a("#form-options").serialize();n+="&"+p,m=k}return m&&(n+="&id="+m),a.ajax({type:"post",url:ajaxurl,data:{action:"ezfc_backend",data:n},success:function(k){if(a(".spinner").fadeOut("fast"),k=a.parseJSON(k),!k)return a(".ezfc-error").text("Something went wrong. :("),!1;if(k.error)return a(".ezfc-error").text(k.error),!1;if(a(".ezfc-error").text(""),k.message&&a(".ezfc-message").text(k.message),"element_get"==h&&element_show(k.element[0]),("form_add"==h||"form_duplicate"==h)&&c(k),"form_get"==h&&g(k),"form_get_submissions"==h&&i(k),"form_delete"==h&&d(m),"form_file_delete"==h&&e(m),f(""),"form_preview"==h&&f(k),"form_save"==h&&(form_changed=!1,a(".ezfc-forms-list .button-primary span").text(a("#ezfc-form-name").val())),"form_save_template"==h){var n=a("#ezfc-form-name").val();a("#ezfc-form-template-id").append("<option value='"+k+"'>"+n+"</option>")}"form_template_delete"==h&&a("#ezfc-form-template-id option[value='"+m+"']").remove(),"form_element_delete"==h&&(a(b).parents(".ezfc-form-element").remove(),l()),"form_element_add"==h&&(a(".ezfc-form-elements").append(j(k)),l()),"form_submission_delete"==h&&a(b).parents(".ezfc-form-submission").remove(),"form_update_options"==h&&(a(".ezfc-forms-list li[data-id='"+m+"'] .ezfc-form-name").text(a("#opt-name").val()),a(".ezfc-dialog").dialog("close"))}}),!1}function o(a){return(a+"").replace(/\\(.?)/g,function(a,b){switch(b){case"\\":return"\\";case"0":return"\0";case"":return"";default:return b}})}form_changed=!1,a(".ezfc-dialog").dialog({autoOpen:!1,height:600,width:700,modal:!0,buttons:{"Update options":function(){a(".ezfc-option-save").click()},Cancel:function(){a(this).dialog("close")}}}),a("body").on("click","[data-action]",function(){if("form_get"==a(this).data("action")&&form_changed&&!confirm(ezfc_vars.form_changed))return a(".spinner").hide(),!1;m(a(this));var b=a(this).data("selectgroup");return b&&(a(".button-primary[data-selectgroup='"+b+"']").removeClass("button-primary"),a(this).addClass("button-primary")),!1}),a("body").on("click",".ezfc-form-element-name",function(){a(this).parent().find(".ezfc-form-element-data").toggle()}),a("body").on("click",".ezfc-form-submission-name",function(){a(this).parent().find(".ezfc-form-submission-data").toggle()});var b;a("body").on("click",".ezfc-image-upload",function(c){c.preventDefault();var d=this;return b?(b.open(),void 0):(b=wp.media.frames.file_frame=wp.media({title:jQuery(this).data("uploader_title"),button:{text:jQuery(this).data("uploader_button_text")},multiple:!1}),b.on("select",function(){var c=b.state().get("selection").first().toJSON();a(d).parents(".ezfc-form-element-data").find("[data-element-name='image']").val(c.url),a(d).parents(".ezfc-form-element-data").find(".ezfc-image-preview").attr("src",c.url)}),b.open(),void 0)}),a(".ezfc-toggle-show").on("click",function(){a(".ezfc-form-element-data, .ezfc-form-submission-data").show()}),a(".ezfc-toggle-hide").on("click",function(){a(".ezfc-form-element-data, .ezfc-form-submission-data").hide()}),a("body").on("click",".ezfc-form-element-option-add",function(){form_changed=!0;var b=a(this).data("element_id"),c=a(a(this).data("target")+"[data-element_id='"+b+"']:last"),d=a(c).data("row"),e=parseInt(d)+1,f="<tr class='ezfc-form-element-option' data-element_id='"+b+"' data-row='"+e+"'>";return f+="<td><input class='ezfc-form-element-option-value' name='elements["+b+"][options]["+e+"][value]' value='"+e+"' /></td>",f+="<td><input class='small ezfc-form-element-option-text' name='elements["+b+"][options]["+e+"][text]' value='Option "+e+"' />",f+="<button class='button ezfc-form-element-option-delete' data-target='.ezfc-form-element-option' data-target_row='"+e+"' data-element_id='"+b+"'>X</button></td>",f+="</tr>",a(f).insertAfter(c),!1}),a("body").on("click",".ezfc-form-element-option-delete",function(){var b=a(this).data("target_row"),c=a(this).data("element_id"),d=a(a(this).data("target")+"[data-row='"+b+"'][data-element_id='"+c+"']"),e=a(a(this).data("target")+"[data-element_id='"+c+"']").length;return 1>=e?!1:(a(d).remove(),!1)}),a("body").on("keyup",".ezfc-form-element-data input[data-element-name='label']",function(){form_changed=!0;var b=a(this).val();a(this).parents(".ezfc-form-element").find(".element-label").text(b)}),a("body").on("click",".ezfc-form-element-required-toggle",function(){form_changed=!0;var b=1==a(this).val()?"*":"";a(this).parents(".ezfc-form-element").find(".ezfc-form-element-required-char").text(b)}),a("body").on("click","form .ezfc-element-submit",function(){return!1}),String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}});